<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>HTML Crossbreeder</title>
	<script>
		function crossbreed(out_element, lhs, rhs) {
			// const out_element = new Document().documentElement;
			// const lhs = document.documentElement;
			// const rhs = document.documentElement;
			let larger = lhs.childElementCount >= rhs.childElementCount ? lhs : rhs;
			let smaller = lhs.childElementCount < rhs.childElementCount ? lhs : rhs;
			const ratio = smaller.childElementCount / larger.childElementCount;

			let smaller_overflow = 0;
			for (let i = 0; i < larger.childElementCount; i++) {
				smaller_overflow += ratio;
				const larger_element = larger.children[i];
				if (smaller_overflow < 1) {
					out_element.appendChild(larger_element.cloneNode());
				} else {
					smaller_overflow -= 1;
					const smaller_element = smaller.children[Math.floor(i / larger.childElementCount * smaller.childElementCount)]
					const new_node = chooseDominantNode(larger_element, smaller_element);
					crossbreed(new_node, larger_element, smaller_element);
					out_element.appendChild(new_node);
				}
			}
		}

		function chooseDominantNode(lhs, rhs) {
			// const lhs = document.documentElement;
			// const rhs = document.documentElement;
			const type = Math.random() > 0.5 ? lhs.nodeName : rhs.nodeName;

			const new_element = document.createElement(type);

			const lhs_attributes = new Set();

			for (let i = 0; i < lhs.attributes.length; i++) {
				const attrib = lhs.attributes[i];
				lhs_attributes.add(attrib.name);
			}
			for (let i = 0; i < rhs.attributes.length; i++) {
				const attrib = rhs.attributes[i];
				if (lhs_attributes.has(attrib.name)) {
					if (Math.random() > 0.5) {
						new_element.setAttribute(attrib.name, attrib.value);
						lhs_attributes.delete(attrib.name)
					}
				}
			}
			for (let i = 0; i < lhs.attributes.length; i++) {
				const attrib = lhs.attributes[i];
				if (lhs_attributes.has(attrib.name)) {
					new_element.setAttribute(attrib.name, attrib.value);
				}
			}
			return new_element;
		}

		function getPageAsString(document) {
			return "<!DOCTYPE html>\n" + document.innerHTML;
		}


		function download(file) {
			const temp_a = document.createElement("a");
			const temp_file_url = URL.createObjectURL(file);
			temp_a.href = temp_file_url;
			// temp_a.download = "";
			temp_a.click();
			URL.revokeObjectURL(temp_file_url);
		}

		async function loadFile(file) {
			const reader = new FileReader();
			await new Promise((resolve, reject) => {
				reader.addEventListener("load", resolve);
				reader.addEventListener("error", reject);
				reader.readAsText(file);
			});
			return reader.result;
		}

		document.addEventListener("DOMContentLoaded", () => {
			document.getElementById("crossbreed-make-baby").addEventListener("click", async () => {
				const other_file = document.getElementById("other-html").files[0];
				let parser = new DOMParser();
				const other_document = parser.parseFromString(await loadFile(other_file), "text/html");
				parser = null;
				const child_document = document.implementation.createHTMLDocument("Baby page");
				crossbreed(child_document.body, document.body, other_document.body);
				const page_string = getPageAsString(child_document.documentElement);
				download(new File([page_string], "Your Child.html", { "type": "text/html" }));
				// console.debug(page_string);
			});
			document.getElementById("open-crossbreed").addEventListener("click", () => {
				document.getElementById("crossbreed-dialog").showModal();
			})
		});
	</script>
</head>

<body>
	<button id="open-crossbreed">Crossbreed this webpage</button>
	<dialog id="crossbreed-dialog">
		<p>Choose another webpage</p>
		<form method="dialog">
			<label>
				<span>Choose your partner HTML page</span>
				<input id="other-html" type="file" accept="text/html,.htm,.html">
			</label>
			<button id="crossbreed-make-baby">Make a baby!</button>
		</form>
	</dialog>

</body>


</html>